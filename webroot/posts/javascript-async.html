<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JavaScriptç•°æ­¥ç·¨ç¨‹å°çµ - æ¬ä¸€æ§ ğŸ¤“ Solo Web Developer</title><link rel="stylesheet" href="/stylesheets/posts.css?v=MTYwNTgxMDcwOTA3"></head><body><header><h1 class="logo"><a href="/"><span class="logo-name">æ¬ä¸€æ§</span>'s Blog</a></h1></header><article><h1>JavaScriptç•°æ­¥ç·¨ç¨‹å°çµ</h1><div class="meta"><div>é¦–æ¬¡ç¼–è¾‘äº&nbsp;&nbsp;Fri Dec 16 2016 15:18:22 GMT+0800 (China Standard Time)</div></div><p>JavaScriptæ˜¯å–®ç·šç¨‹çš„ï¼Œé™¤äº†ä½ çš„JSä»£ç ï¼Œå…¶å®ƒæ“ä½œéƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„(everything runs in parallel except your code)ã€‚</p><p>åœ¨JSåŸ·è¡Œç·šç¨‹ä¸­é€²è¡Œçš„è¡Œç‚ºè¢«ç¨±ä½œåŒæ­¥(Synchronous)æ“ä½œï¼ŒéJSåŸ·è¡Œç·šç¨‹åŸ·è¡Œçš„è¡Œç‚ºå‰‡è¢«ç¨±å‘¼ç‚ºç•°æ­¥(Asynchronous)æ“ä½œã€‚ è«¸å¦‚Ajax/HTTPè«‹æ±‚ã€I/Oæ“ä½œç­‰è¡Œç‚ºå‡èˆ‡JSåŸ·è¡Œç·šç¨‹ç„¡é—œï¼ˆç”±è‡ªå·±ç¨ç«‹çš„ç·šç¨‹é€²è¡Œé‹ä½œï¼‰ï¼Œé€™äº›è¡Œç‚ºåœ¨åŸ·è¡Œå®Œæˆä¹‹å¾Œæœƒå°‡çµæœé€šçŸ¥åˆ°JSåŸ·è¡Œç·šç¨‹ï¼› å› æ­¤ï¼ŒJSåŸ·è¡Œç·šç¨‹ä¸­æœƒæœ‰å€‹é¡ä¼¼<code>while(true)</code>çš„å¾ªç’°ï¼Œä»¥è§€å¯Ÿè€…çš„å§¿æ…‹<code>ç›£è½</code>ï¼ˆè½®è¯¢ï¼‰æ˜¯å¦æœ‰å…¶å®ƒç·šç¨‹å‚³éæ¶ˆæ¯éä¾†ï¼Œä¸€æ—¦æ•ç²åˆ°å‰‡åŸ·è¡Œæœ¬JSåŸ·è¡Œç·šç¨‹ä¸­ç›¸æ‡‰çš„å‡½æ•¸å¡Šï¼ˆå›èª¿ï¼‰ã€‚</p><p>JavaScriptäº‹ä»¶å¾ªç’°ä¸æ˜¯æœ¬æ–‡çš„é‡é»ï¼ˆ<a href="https://docs.google.com/presentation/d/1-UC3cwd0KZtdSRAd6edLD-CvrOeM-IOpJYcb8rhElBY/edit?usp=sharing">JavaScript Event Loop</a>ï¼‰ï¼Œæœ¬æ–‡åƒ…å°å‰ç«¯ç•°æ­¥ç·¨ç¨‹é€²è¡Œäº›è¨±ç¸½çµã€‚å€‹äººçš„ç†è§£æ˜¯JavaScriptç•°æ­¥ç·¨ç¨‹æ–¹å¼åªæœ‰å…©ç¨®æ–¹å¼ï¼šå›èª¿å’Œè§€å¯Ÿè€…æ¨¡å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>Promises/A+ æ˜¯å¦‚ä½•å„ªé›…åœ°ä½¿ç”¨å›èª¿è€Œè¨­è¨ˆçš„ä¸€ç¨®ç·¨ç¨‹è¦ç¯„ï¼Œæœ¬è³ªä¾èˆŠæ˜¯å›èª¿</li><li>äº‹ä»¶ç›£è½å’Œè§€å¯Ÿè€…æ¨¡å¼ï¼ˆç™¼ä½ˆ/è¨‚é–±æ¨¡å¼ï¼‰å®Œå…¨å¯ä»¥ç†è§£æˆæ˜¯â€œä¸€å€‹å­©å­çš„ä¸åŒæš±ç¨±â€</li><li>Generators æ˜¯ä¸€ç¨®ç‰¹æ€§ï¼Œå¯¦ç¾å‡½æ•¸åœ¨åŸ·è¡Œéç¨‹ä¸­æš«åœã€ä¸¦åœ¨å°‡ä¾†çš„æŸå€‹æ™‚åˆ»æ¢å¾©åŸ·è¡Œçš„åŠŸèƒ½</li><li>Generators+Promises å¯ä»¥æ­é…æ¼‚äº®çš„èªæ³•ç³–ï¼Œå°‡ç•°æ­¥æºç¢¼å¯«å¾—åƒåŒæ­¥æºç¢¼</li></ul><h3 id="callback-functions">Callback Functions</h3><p>å‡½æ•¸å¼ç·¨ç¨‹ä¸­æœ‰å€‹æ¦‚å¿µå«åšé«˜éšå‡½æ•¸(Higher-order Functions)ï¼Œå…¶æœ‰å€‹ç‰¹æ€§æ˜¯ä¸€å€‹å‡½æ•¸å¯ä»¥ä½œç‚ºå¦å¤–ä¸€å€‹å‡½æ•¸çš„åƒæ•¸ã€‚é€šå¸¸æˆ‘å€‘å°‡é‚£å€‹ä½œç‚ºå¦å¤–ä¸€å€‹å‡½æ•¸åƒæ•¸çš„å‡½æ•¸ç¨±å‘¼ç‚ºå›èª¿å‡½æ•¸ã€‚</p><p>ç‚ºæ–¹ä¾¿æè¿°å’Œè§£é‡‹ï¼Œæ­¤è™•æ¨¡æ“¬ä¸€å€‹å…·é«”çš„æ¥­å‹™å ´æ™¯ï¼šé€šéAjaxæ–¹å¼è«‹æ±‚<code>**/api/v1.0/user/{id}</code>æ¥å£ç²å–æŸå€‹ç”¨æˆ¶çš„ä¿¡æ¯(Asynchronous behavior)ï¼Œç„¶å¾Œé‡å°æ‹¿åˆ°çš„ç”¨æˆ¶ä¿¡æ¯é€²è¡Œå¾ŒçºŒçš„è™•ç†ã€‚ å…¸å‹çš„åšæ³•æ˜¯å°‡<code>Ajax</code>ç•°æ­¥è«‹æ±‚ä¹‹å¾Œé€²è¡Œçš„æ“ä½œå°è£æˆ<code>callback()</code>å‡½æ•¸ï¼Œåœ¨æ¥å£è¨ªå•æˆåŠŸå¾—åˆ°ç”¨æˆ¶ä¿¡æ¯ä¹‹å¾Œå†åŸ·è¡Œè©²å‡½æ•¸ï¼š</p><pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUserInfoCallback</span>(<span class="hljs-params">id, callback</span>) </span>{
  $.ajax({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`**/api/v1.0/user/<span class="hljs-subst">${id}</span>`</span>,
    <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> callback(<span class="hljs-literal">null</span>, data),
    <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">xhr, textStatus, errorThrown</span>)
      =&gt;</span> callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(textStatus), errorThrown),
  })
}
getUserInfoCallback(<span class="hljs-string">'10086'</span>, handleUserInfo)</code></pre><h3 id="promisesa">Promises/A+</h3><blockquote><p>An open standard for sound, interoperable JavaScript promisesâ€”by implementers, for implementers.</p></blockquote><p>æ¿«ç”¨å›èª¿å¸¶ä¾†çš„å•é¡Œæ˜¯ä»£ç¢¼é‚è¼¯è€¦åˆåº¦å¾ˆé«˜ï¼Œé¢è‡¨å›èª¿ç½é›£ã€‚Promises/A+æ˜¯ç¨®åˆç†ä½¿ç”¨å›èª¿çš„<strong>è¦ç¯„</strong>ï¼Œé¿å…å›èª¿çš„æ¿«ç”¨ã€‚</p><h4 id="ç‰¹é»ä¸€ï¼šæä¾›å¥½çœ‹çš„apiï¼Œç”±åµŒå¥—å›èª¿callback-hellè½‰å‘éˆå¼èªæ³•">ç‰¹é»ä¸€ï¼šæä¾›å¥½çœ‹çš„APIï¼Œç”±åµŒå¥—å›èª¿(<a href="http://callbackhell.com/">callback hell</a>)è½‰å‘éˆå¼èªæ³•</h4><p>é¦–å…ˆå°‡è«‹æ±‚ç”¨æˆ¶ä¿¡æ¯çš„Ajaxç•°æ­¥æ“ä½œåŒ…è£æˆä¸€å€‹Promiseå¯¦ä¾‹ï¼Œå¾ŒçºŒçš„åŒæ­¥è¡Œç‚ºé€šéè©²å¯¦ä¾‹å°è±¡çš„<code>then()</code>æ–¹æ³•èª¿ç”¨ã€‚</p><pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUserInfoPromise</span>(<span class="hljs-params">id</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">fulfill, reject</span>) =&gt;</span> {
    $.ajax({
      <span class="hljs-attr">url</span>: <span class="hljs-string">`**/api/v1.0/user/<span class="hljs-subst">${id}</span>`</span>,
      <span class="hljs-attr">success</span>: fulfill,
      <span class="hljs-attr">error</span>: reject,
    }) <span class="hljs-comment">// end $.ajax</span>
  }) <span class="hljs-comment">// end return</span>
} <span class="hljs-comment">// end getUserInfoPromise</span>

getUserInfoPromise(<span class="hljs-string">'10086'</span>)
  .then(<span class="hljs-function"><span class="hljs-params">userInfo</span> =&gt;</span> handleUserInfo)
  .catch(<span class="hljs-built_in">console</span>.log)</code></pre><h4 id="ç‰¹é»äºŒï¼špromises-ä¸æœƒèˆ‡å›èª¿ç¶å®šè€¦åˆï¼Œå¯ç·©å­˜ç•°æ­¥æ“ä½œçµæœ">ç‰¹é»äºŒï¼šPromises ä¸æœƒèˆ‡å›èª¿ç¶å®šè€¦åˆï¼Œå¯ç·©å­˜ç•°æ­¥æ“ä½œçµæœ</h4><p>å‡è¨­å­˜åœ¨é€™æ¨£çš„ä¸€å€‹æ¥­å‹™å ´æ™¯ï¼šç²å–ç”¨æˆ¶idç‚º<code>10086</code>çš„ç”¨æˆ¶ä¿¡æ¯ï¼Œç„¶å¾Œåœ¨ä¸åŒçš„å…©å€‹éšæ®µå°å…¶ç•°æ­¥æ“ä½œç²å–çš„ç”¨æˆ¶ä¿¡æ¯é€²è¡Œå…©ç¨®ä¸åŒçš„æ“ä½œï¼ˆåˆ†åˆ¥ç‚º<code>handleUserInfo()</code>å’Œ<code>console.log()</code>ï¼‰ã€‚ åœ¨å…©å€‹éšæ®µä¸­ï¼Œéƒ½éœ€è¦ç•°æ­¥æ“ä½œç²å–å¾—åˆ°çš„<code>userInfo</code>æ•¸æ“šï¼Œå¦‚æœæ¡ç”¨å‚³çµ±å›èª¿æ–¹å¼ï¼Œä¸€èˆ¬æ¡ç”¨é–‰åŒ…çš„æ–¹å¼ç·©å­˜<code>userInfo</code>æˆ–è€…æš´åŠ›é»é‡è¤‡é€²è¡Œä¸€æ¬¡Ajaxç•°æ­¥è«‹æ±‚ã€‚</p><p>ä½†æ˜¯æ¡ç”¨Promiseæ–¹å¼ï¼Œå‰‡ç„¡éœ€é€™äº›å¾ˆ<strong>è¤‡é›œ</strong>çš„å¯¦ç¾æ–¹å¼ï¼Œå› ç‚ºå¯ä»¥é‡è¤‡ä½¿ç”¨Promiseå°è±¡ã€‚</p><pre><code class="language-js"><span class="hljs-comment">// é–‰åŒ…ç·©å­˜</span>
<span class="hljs-keyword">let</span> globUserInfo = <span class="hljs-literal">null</span>
getUserInfoCallback(<span class="hljs-string">'10086'</span>, userInfo =&gt; globUserInfo = userInfo)
<span class="hljs-comment">// é›£ä»¥ä¿è­‰ globUserInfo å·²ç¶“æ›´æ–°</span>
handleUserInfo(globUserInfo)
<span class="hljs-built_in">console</span>.log(globUserInfo)

<span class="hljs-comment">// é€²è¡Œäº†å…©æ¬¡ç•°æ­¥æ“ä½œ</span>
getUserInfoCallback(<span class="hljs-string">'10086'</span>, handleUserInfo)
getUserInfoCallback(<span class="hljs-string">'10086'</span>, <span class="hljs-built_in">console</span>.log)

<span class="hljs-comment">// ä¿å­˜Promiseå°è±¡</span>
<span class="hljs-keyword">const</span> userInfoPromise = getUserInfoPromise(<span class="hljs-string">'10086'</span>)
userInfoPromise.then(handleUserInfo)
<span class="hljs-comment">// å¯ä»¥å†æ¬¡ä½¿ç”¨`userInfoPromise`å°è±¡</span>
userInfoPromise.then(<span class="hljs-built_in">console</span>.log)</code></pre><ul><li>é€™ç¨®ç­–ç•¥å’Œå‡½æ•¸å¼ç·¨ç¨‹ä¸­<a href="https://en.wikipedia.org/wiki/Lazy_evaluation">lazy evaluation</a>æ¦‚å¿µæ˜¯é¡ä¼¼çš„ï¼Œå¼·èª¿<code>call-by-need</code>ã€‚</li><li>ä¹Ÿå¯ä»¥å°ç•°æ­¥æ“ä½œé€²è¡ŒæŸ¯è£¡åŒ–(<a href="https://en.wikipedia.org/wiki/Currying">Curring</a>)æš«å­˜ç•°æ­¥æ“ä½œçš„çµæœï¼ˆé¡ä¼¼çš„æ¦‚å¿µé‚„æœ‰thunkï¼Œåƒè€ƒ<a href="https://github.com/tj/node-thunkify">node-thunkify</a>ï¼‰ã€‚</li></ul><h4 id="ç‰¹é»ä¸‰ï¼šå¯çµ„åˆï¼Œå¾©ç”¨">ç‰¹é»ä¸‰ï¼šå¯çµ„åˆï¼Œå¾©ç”¨</h4><p>é¡ä¼¼æ–¼å‡½æ•¸å¼ç·¨ç¨‹ä¸­æ¨å»£çš„å¾å·²æœ‰çš„å‡½æ•¸ä¸­å‰µå»ºæ–°å‡½æ•¸ï¼Œä¹Ÿå¯ä»¥é€šéå·²æœ‰çš„Promiseå°è±¡ç”Ÿæˆæ–°çš„Promiseå°è±¡ã€‚ æ¯”å¦‚ç²å–å¤šå€‹ç”¨æˆ¶ä¿¡æ¯ï¼Œå¯ä½¿ç”¨<code>Promise.all()</code>æ–¹æ³•å¯¦ç¾ç•°æ­¥æ“ä½œçš„çµ„åˆï¼š</p><pre><code class="language-js"><span class="hljs-keyword">const</span> promises = [<span class="hljs-string">'10010'</span>, <span class="hljs-string">'10086'</span>, <span class="hljs-string">'10000'</span>].map(
  <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(
    <span class="hljs-function">(<span class="hljs-params">fulfill, reject</span>) =&gt;</span> $.ajax({
      <span class="hljs-attr">url</span>: <span class="hljs-string">`**/api/v1.0/user/<span class="hljs-subst">${id}</span>`</span>,
      <span class="hljs-attr">success</span>: fulfill, <span class="hljs-attr">error</span>: reject,
    })
))
<span class="hljs-keyword">const</span> userInfosPromise = <span class="hljs-built_in">Promise</span>.all(promises)
  .then(<span class="hljs-built_in">console</span>.log)
  .catch(<span class="hljs-built_in">console</span>.log)</code></pre><blockquote><p>æ„Ÿè¦ºä¸ŠPromise/A+è¦ç¯„æ˜¯å‡½æ•¸å¼ç·¨ç¨‹æ¦‚å¿µåœ¨å‰ç«¯é ˜åŸŸçš„ä¸€æ¬¡æœ€ä½³å¯¦è¸ï¼ˆå›èª¿çš„èªæ³•ç³–ï¼‰ã€‚æ›´å¤šè©³ç´°çš„å…§å®¹å¾…è£œå……ã€‚</p></blockquote><h3 id="event-emitters">Event Emitters</h3><p>äº‹ä»¶ç›£è½å¼ç•°æ­¥ç·¨ç¨‹æœ¬è³ªä¸Šé‚„æ˜¯ä¾è³´æ–¼å›èª¿å‡½æ•¸å¯¦ç¾çš„ï¼Œå€åˆ¥åœ¨æ–¼å›èª¿å‡½æ•¸ä¸¦ä¸åŸ·è¡Œç•°æ­¥è¡Œç‚ºå®Œæˆå¾Œéœ€è¦çš„æ“ä½œï¼Œè€Œæ˜¯ç™¼ä½ˆä¸€å€‹é€šçŸ¥å»è§¸ç™¼åŸ·è¡Œç›¸æ‡‰çš„å‡½æ•¸ã€‚</p><pre><code class="language-js"><span class="hljs-keyword">import</span> EventEmitter <span class="hljs-keyword">from</span> <span class="hljs-string">'events'</span>
<span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> EventEmitter()
<span class="hljs-comment">// è¨»å†Š</span>
emitter.on(<span class="hljs-string">'event'</span>, handleUserInfo)
$.ajax({
  <span class="hljs-attr">url</span>: <span class="hljs-string">`**/api/v1.0/user/10086`</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> emitter.emit(<span class="hljs-string">'event'</span>, data), <span class="hljs-comment">// è§¸ç™¼ï¼šç•°æ­¥æ“ä½œé€™å€‹è¡Œç‚ºå¸¶ä¾†çš„å½±éŸ¿</span>
  <span class="hljs-attr">error</span>: <span class="hljs-built_in">console</span>.log,
})</code></pre><p>äº‹ä»¶ç›£è½å…¶å¯¦æ˜¯è§€å¯Ÿè€…æ¨¡å¼çš„ä¸€ç¨®å¯¦ç¾ï¼šç•¶ä¸€å€‹å°è±¡ç™¼ç”Ÿè®ŠåŒ–æ™‚ï¼Œæ‰€æœ‰ä¾è³´ä»–çš„ç›¸é—œæ“ä½œéƒ½æœƒå¾—åˆ°é€šçŸ¥ï¼Œåªä¸éäº‹ä»¶ç›£è½å¼±åŒ–äº†å°è±¡çš„è®ŠåŒ–è€Œå¼·èª¿è¡Œç‚ºï¼ˆå°è±¡æ•¸æ“šè®Šæ›´ä¹Ÿæ˜¯ä¸€ç¨®è¡Œç‚ºï¼‰ã€‚ æ¯”å¦‚ä¸Šé¢çš„ä»£ç¢¼æ®µå¼·èª¿çš„æ˜¯Ajaxæ“ä½œé€™å€‹è¡Œç‚ºï¼Œä¸€æ—¦å®Œæˆå°±<strong>é€šçŸ¥</strong>åˆ°<code>handleUserInfo()</code>å‡½æ•¸çš„èª¿ç”¨ï¼Œä¸¦æ”œå¸¶åƒæ•¸è®Šæ›´å°è±¡æ•¸æ“šã€‚</p><p>å¦‚æœæ¡ç”¨è§€å¯Ÿè€…æ¨¡å¼çš„è©±ï¼Œä¸€èˆ¬é€™æ¨£ç›´æ¥è™•ç†æ•¸æ“šï¼ˆå¼·èª¿æ•¸æ“šè®ŠåŒ–å¸¶ä¾†çš„å½±éŸ¿ï¼Œé€ æˆæ•¸æ“šè®ŠåŒ–çš„å ´æ™¯å¯èƒ½å­˜åœ¨å¤šè™•ï¼‰ï¼Œç„¶å¾Œè§¸ç™¼æ•¸æ“šè®Šå‹•å¾Œçš„è¡Œç‚ºï¼š</p><pre><code class="language-js"><span class="hljs-keyword">let</span> userInfo = <span class="hljs-literal">null</span>
emitter.on(<span class="hljs-string">'event'</span>, () =&gt; handleUserInfo(userInfo))
<span class="hljs-keyword">const</span> updateUserInfo = <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  userInfo = data       <span class="hljs-comment">// userInfoå°è±¡æ–¹å¼è®Šæ›´</span>
  emitter.emit(<span class="hljs-string">'event'</span>) <span class="hljs-comment">// é€šçŸ¥ç›¸é—œä¾è³´çš„æ“ä½œï¼šæ•¸æ“šè®Šæ›´å¸¶ä¾†çš„å½±éŸ¿</span>
}
$.ajax(
  url: <span class="hljs-string">`**/api/v1.0/user/10086`</span>,
  <span class="hljs-attr">success</span>: updateUserInfo, <span class="hljs-comment">// è§¸ç™¼</span>
  <span class="hljs-attr">error</span>: <span class="hljs-built_in">console</span>.log,
})</code></pre><p>å¾ˆæ˜é¡¯ï¼Œè§€å¯Ÿè€…æ¨¡å¼è¦æ¯”äº‹ä»¶ç›£è½æ–¹å¼æ“´å……æ€§æ›´å¼·ï¼ˆé›–ç„¶æœ¬è³ªä¸€è‡´ï¼Œä½†æ˜¯å¼·èª¿å´é‡é»ä¸åŒï¼‰ã€‚</p><figure style="padding-top: 0;margin-top: .5em;"><img src="/images/posts/pingpong.gif" alt="containing block"><figcaption>é™·å…¥`emit`æ­»å¾ªç’°</figcaption></figure>äº‹ä»¶ç›£è½å¼ç•°æ­¥ç·¨ç¨‹ç„¡ç•°æ–¼`goto`èªå¥ï¼Œç¨æœ‰ä¸æ…å½¢å¦‚`on()`ã€`emit()`ã€`subscribe()`ã€`publish()`ç­‰æ–¹æ³•æ‘»é›œåœ¨å„è™•ï¼Œâ€œå‰ªä¸æ¸…ï¼Œç†é‚„äº‚â€ï¼› å¦‚æœä¸æ˜¯â€œç´„å®šâ€åŒ–ç·¨ç¨‹ä¸å»ºè­°æ¡ç”¨ã€‚æ¯”å¦‚ä¸‹é¢é€™æ®µæºç¢¼ï¼Œç¨ä¸æ…å°±é™·å…¥å¦‚åœ–1æ‰€ç¤ºå ´æ™¯ã€‚<pre><code class="language-js"><span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> EventEmitter()
<span class="hljs-keyword">const</span> foo = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> emitter.emit(<span class="hljs-string">'bar'</span>)
<span class="hljs-keyword">const</span> bar = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> emitter.emit(<span class="hljs-string">'foo'</span>)
emitter.on(<span class="hljs-string">'foo'</span>, foo)
emitter.on(<span class="hljs-string">'bar'</span>, bar)
foo()    <span class="hljs-comment">// é™·å…¥æ­»å¾ªç’°</span></code></pre><p>å’Œå›èª¿å¼ç•°æ­¥ç·¨ç¨‹ï¼ˆåŒ…æ‹¬Promises/A+è¦ç¯„ï¼‰ç›¸æ¯”ï¼Œäº‹ä»¶ç›£è½å¼ç•°æ­¥ç·¨ç¨‹çš„è»Ÿè‚‹åœ¨æ–¼éœ€è¦æ‰‹å‹•è¨»å†Š(Manual)ã€‚ åŸæœ¬å¯ä»¥é€šéæ•¸æ“šç¶å®š(Data binding)<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/observe">Object.observe()</a>æ–¹æ³•ä¾†å¯¦ç¾è§€å¯Ÿè€…æ¨¡å¼ï¼Œå¾ˆå¯æƒœè©²æ–¹æ³•å·²è¢«<code>deprecated</code>æ‰ï¼›ç›®å‰æ¨è–¦çš„æ˜¯<code>get</code>å’Œ<code>set</code>+<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a>æ–¹å¼å¯¦ç¾ï¼ˆç›¸é—œè¨è«–ï¼š<a href="http://stackoverflow.com/questions/36258502/why-object-observe-has-been-deprecated">36258502</a>ï¼‰ã€‚</p><p>ä½†æ˜¯æ‰‹å‹•ç¶­è­·é€™äº›<code>on()</code>ã€<code>emit()</code>ã€<code>get()</code>ã€<code>set()</code>ç­‰æ–¹æ³•åœ¨é …ç›®æ˜¯å¾ˆæŠ˜é¨°çš„ï¼Œé€šéä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·åŒ…å¯ä»¥å¯¦ç¾ç”±<code>Manual</code>åˆ°<code>Automatic</code>è½‰è®Šã€‚ æ¯”å¦‚æ¡ç”¨<a href="http://mobxjs.github.io/mobx/index.html">MobX</a>å¯ä»¥å¯¦ç¾å¾—æ›´åŠ å„ªé›…ï¼š</p><pre><code class="language-js"><span class="hljs-keyword">import</span> { observable, autorun } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>
<span class="hljs-keyword">const</span> store = observable({<span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>})
<span class="hljs-comment">// åªè¦è®Šå‹•`store`å°è±¡ï¼Œå°±æœƒè‡ªå‹•è§¸ç™¼`handleUserInfo()`å‡½æ•¸</span>
autorun(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> handleUserInfo(store.userInfo))
$.ajax(
  url: <span class="hljs-string">`**/api/v1.0/user/10086`</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> store.userInfo = data,
  <span class="hljs-attr">error</span>: <span class="hljs-built_in">console</span>.log,
})</code></pre><h3 id="generator">Generator</h3><h4 id="coroutine-å”ç¨‹-aka-co-operative-routines"><a href="https://en.wikipedia.org/wiki/Coroutine">Coroutine</a> å”ç¨‹ (a.k.a. co-operative routines)</h4><p>ä¸€èˆ¬ç¨‹åºä¸­ï¼Œå‡½æ•¸èª¿ç”¨ä¸€å®šæ˜¯å¾é ­åˆ°å°¾åŸ·è¡Œç›´åˆ°é‡åˆ°<code>return</code>æˆ–åŸ·è¡Œå®Œï¼› è€Œcoroutine å‰‡å®¹è¨±å‡½æ•¸åŸ·è¡Œåˆ°ä¸€åŠæ™‚å°±ä¸­æ–·(yield)ï¼Œä¸­æ–·æ™‚å‡½æ•¸å…§éƒ¨ä¸Šä¸‹æ–‡ç’°å¢ƒ(context)æœƒè¢«ç·©å­˜ä¸‹ä¾†ã€‚ ç¨‹åºä¸»é«”å¯ä»¥éš¨æ™‚æ¢å¾©(resume)é€™å€‹è¢«ç·©å­˜çš„coroutineï¼Œç¹¼çºŒå¾å‰›æ‰è¢«ä¸­æ–·è™•åŸ·è¡Œå¾ŒçºŒå…§å®¹ã€‚</p><pre><code class="language-js"><span class="hljs-function"><span class="hljs-keyword">function</span> *<span class="hljs-title">foo</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hello'</span>)
  <span class="hljs-keyword">yield</span> <span class="hljs-number">10086</span>           <span class="hljs-comment">// åœ¨æ­¤è™•ä¸­æ–· coroutine</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'world'</span>)
}

<span class="hljs-keyword">const</span> bar = foo()                   <span class="hljs-comment">// ä¿å­˜ coroutine å…§éƒ¨ç‹€æ…‹çš„è®Šé‡</span>
bar.next()                          <span class="hljs-comment">// èª¿ç”¨`foo()`å‡½æ•¸ï¼Œé‡åˆ° yield ä¸­æ–·ç¨‹åºèª¿ç”¨</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'main, not in `foo()`'</span>) <span class="hljs-comment">// å·²ç¶“å¾`foo()`å‡½æ•¸ä¸­è·³å‡ºä¾†äº†ï¼Œå¯ä»¥å¹¹äº›å…¶å®ƒäº‹æƒ…</span>
bar.next()                          <span class="hljs-comment">// æ¢å¾©`foo()`çš„èª¿ç”¨ï¼Œå¾ yield ä¸­æ–·è™•ç¹¼çºŒåŸ·è¡Œ</span></code></pre><h4 id="thread-vs-coroutine">Thread VS Coroutine</h4><blockquote><p>With threads, the operating system switches running threads preemptively according to its scheduler, which is an algorithm in the operating system kernel. With coroutines, the programmer and programming language determine when to switch coroutines; in other words, tasks are cooperatively multitasked by pausing and resuming functions at set points, typically (but not necessarily) within a single thread.<br>â€”â€” <a href="http://stackoverflow.com/questions/1934715/difference-between-a-coroutine-and-a-thread">stackoverflow: difference-between-a-coroutine-and-a-thread</a></p></blockquote><h4 id="generator-aka-semicoroutines-vs-coroutine"><a href="https://en.wikipedia.org/wiki/Generator_(computer_programming)">Generator</a> (a.k.a. semicoroutines) VS Coroutine</h4><p>Generatorèˆ‡Coroutine çš„å€åˆ¥æ˜¯Generator åªèƒ½å¾ä¸Šæ¬¡ä¸­æ–·è™•ç¹¼çºŒåŸ·è¡Œï¼Œè€ŒCoroutineå‰‡æ²’æœ‰é€™æ¨£çš„é™åˆ¶ï¼ˆå¯ä»¥æŒ‡å®šå¾å“ªè£¡ç¹¼çºŒåŸ·è¡Œï¼‰ã€‚ å› æ­¤ï¼ŒGeneratorå¯ä»¥è¦–ä½œæ˜¯Coroutineçš„ä¸€ç¨®ç‰¹æ®Šæƒ…æ³ï¼Œä¸Šæ–‡æ¶‰åŠçš„æºç¢¼ä¾‹å­å…¶å¯¦å°±æ˜¯Generatorçš„æ‡‰ç”¨èˆ‰ä¾‹ã€‚ å…¶ä¸­ï¼ŒGeneratoræ¶‰åŠ<code>bar.next()</code>è‡ªå‹•æµç¨‹ç®¡ç†çš„è§£æ±ºæ–¹æ¡ˆå¯ä»¥åƒè€ƒ<a href="https://github.com/tj/co">co</a>ã€<a href="https://github.com/thunks/thunks">thunks</a>ç­‰ã€‚</p><h4 id="asyncawait-èªæ³•ç³–">async/await â€œèªæ³•ç³–â€</h4><p>è²æ˜çš„<code>async</code>å‡½æ•¸å°±æ˜¯å°‡Generatorå‡½æ•¸å’Œè‡ªå‹•åŸ·è¡Œå™¨åŒ…è£åœ¨ä¸€å€‹å‡½æ•¸è£¡é¢ï¼ˆåƒè€ƒ<a href="https://gist.github.com/solome/064e48f5205943dff7d4918b3bf18e0d">async2generator()</a>ï¼‰ï¼Œ ä»¥é”åˆ°ç•°æ­¥ç·¨ç¢¼ç·¨ç¨‹æ¨¡å¼èˆ‡åŒæ­¥ç·¨ç¢¼ä¸€è‡´ã€‚</p><pre><code class="language-js"><span class="hljs-keyword">const</span> run = <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">fulfill, reject</span>) =&gt;</span> {
    $.ajax({
      <span class="hljs-attr">url</span>: <span class="hljs-string">`**/api/v1.0/user/<span class="hljs-subst">${id}</span>`</span>,
      <span class="hljs-attr">success</span>: fulfill,
      <span class="hljs-attr">error</span>: reject,
    }) <span class="hljs-comment">// end $.ajax</span>
  }) <span class="hljs-comment">// end return</span>
  handleUserInfo(userInfo)
}</code></pre><h3 id="ä¸æ˜¯ç¸½çµçš„ç¸½çµ">ä¸æ˜¯ç¸½çµçš„ç¸½çµ</h3><ul><li>å‡½æ•¸å¼ç·¨ç¨‹é ˜åŸŸçš„çŸ¥è­˜é‚„æ˜¯è¦å¤šå¤šæ¥è§¸çš„ã€‚</li><li>æœ‰äº›å‰ç«¯é ˜åŸŸçš„æ–°é®®äº‹ç‰©åœ¨å…¶ä»–é ˜åŸŸå¯èƒ½å°±æ˜¯äº›ç¿’ä»¥ç‚ºå¸¸çš„æ±è¥¿ï¼Œæ“´å……çŸ¥è­˜é¢å¾ˆé‡è¦ã€‚</li></ul><h3 id="references">References</h3><ul><li><a href="http://callbackhell.com/">Callback Hell</a>: A guide to writing asynchronous JavaScript programs.</li><li><a href="https://promisesaplus.com/">Promises/A+</a>: An open standard for sound, interoperable JavaScript promisesâ€”by implementers, for implementers.</li><li><a href="https://www.promisejs.org/">promisejs.org</a>: A website dedicated to promises in JavaScript.</li><li><a href="https://facebook.github.io/regenerator/">regenerator</a>: Source transformer enabling ECMAScript 6 generator functions in JavaScript-of-today.</li><li><a href="https://github.com/tc39/ecmascript-asyncawait">ecmascript-asyncawait</a>: Async/await for ECMAScript.</li><li><a href="http://devsmash.com/blog/whats-the-big-deal-with-generators">whats-the-big-deal-with-generators</a></li><li><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4287.pdf">Threads, Fibers &amp; Coroutines</a></li></ul></article><footer class="footer"><div class="footer-nav-wrapper"><div class="fnw-col"><h2 class="fnw-heading">Social Networking</h2><ul><li><a href="//github.com/solome"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg></span><span class="username">solome</span></a></li><li><a href="//twitter.com/juyipeng"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg></span><span class="username">juyipeng</span></a></li></ul></div><div class="fnw-col"><h2 class="fnw-heading">Blogroll</h2><ul><li><a href="//ja.numberempire.com/" target="_blank">æ•°ã®å¸å›½</a></li><li><a href="//solome.js.org/thf/blog/" target="_blank">ç”œå°ç«‹</a></li><li><a href="//www.zhihu.com/people/solome" target="_blank">æ¬ä¸€æ§@çŸ¥ä¹</a></li></ul></div></div><div class="fnw-copyright"><ul class="contact-list"><li>ç‰ˆæƒå£°æ˜ï¼š<a href="//creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">çŸ¥è¯†å…±äº« ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™… è®¸å¯åè®®</a>ã€‚<br>Â© 2014 - 2020 <a href="/">æ¬ä¸€æ§</a></li></ul></div></footer></body></html>